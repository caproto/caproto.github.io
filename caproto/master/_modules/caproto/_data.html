

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>caproto._data &mdash; caproto 0+untagged.1.ge011f4f documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/inheritance.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/doctr-versions-menu.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> caproto
          

          
          </a>

          
            
            
              <div class="version">
                0+untagged.1.ge011f4f
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Install Caproto</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../clients.html">Clients</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../servers.html">Servers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../environment_variables.html">Environment Variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../shark.html">Shark (pcap/tcpdump parsing)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../loggers.html">Logging</a></li>
</ul>
<p class="caption"><span class="caption-text">IOCs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../iocs.html">Input-Output Controllers (IOCs)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../records.html">Records</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cookiecutter.html">IOC Template Cookiecutters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../own_docs.html">Writing Your Own Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../server_api.html">Server API</a></li>
</ul>
<p class="caption"><span class="caption-text">Channel Access Sans I/O</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../basics.html">Writing Your Own Channel Access Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">Core API Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">pvAccess</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../pva/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pva/clients.html">Synchronous Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pva/iocs.html">Input-Output Controllers (IOCs)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pva/api.html">PVAccess API</a></li>
</ul>
<p class="caption"><span class="caption-text">Appendix</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../protocol-compliance.html">Details of our Protocol Compliance for CA Nerds</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../references.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes.html">Release History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../containers.html">Caproto-in-a-box</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">caproto</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>caproto._data</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for caproto._data</h1><div class="highlight"><pre>
<span></span><span class="c1"># These classes ChannelData classes hold the state associated with the data</span>
<span class="c1"># source underlying a Channel, including data values, alarm state, and</span>
<span class="c1"># metadata. They perform data type conversions in response to requests to read</span>
<span class="c1"># data as a certain type, and they push updates into queues registered by a</span>
<span class="c1"># higher-level server.</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">weakref</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span>

<span class="kn">from</span> <span class="nn">._backend</span> <span class="kn">import</span> <span class="n">backend</span>
<span class="kn">from</span> <span class="nn">._commands</span> <span class="kn">import</span> <span class="n">parse_metadata</span>
<span class="kn">from</span> <span class="nn">._constants</span> <span class="kn">import</span> <span class="n">MAX_ENUM_STATES</span><span class="p">,</span> <span class="n">MAX_ENUM_STRING_SIZE</span>
<span class="kn">from</span> <span class="nn">._dbr</span> <span class="kn">import</span> <span class="p">(</span><span class="n">DBR_STSACK_STRING</span><span class="p">,</span> <span class="n">DBR_TYPES</span><span class="p">,</span> <span class="n">AccessRights</span><span class="p">,</span> <span class="n">AlarmSeverity</span><span class="p">,</span>
                   <span class="n">AlarmStatus</span><span class="p">,</span> <span class="n">ChannelType</span><span class="p">,</span> <span class="n">GraphicControlBase</span><span class="p">,</span>
                   <span class="n">SubscriptionType</span><span class="p">,</span> <span class="n">_channel_type_by_name</span><span class="p">,</span>
                   <span class="n">_LongStringChannelType</span><span class="p">,</span> <span class="n">native_type</span><span class="p">,</span> <span class="n">native_types</span><span class="p">,</span>
                   <span class="n">time_types</span><span class="p">,</span> <span class="n">timestamp_to_epics</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">._utils</span> <span class="kn">import</span> <span class="p">(</span><span class="n">CaprotoError</span><span class="p">,</span> <span class="n">CaprotoValueError</span><span class="p">,</span> <span class="n">ConversionDirection</span><span class="p">,</span>
                     <span class="n">is_array_read_only</span><span class="p">)</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Forbidden&#39;</span><span class="p">,</span>
           <span class="s1">&#39;ChannelAlarm&#39;</span><span class="p">,</span>
           <span class="s1">&#39;ChannelByte&#39;</span><span class="p">,</span>
           <span class="s1">&#39;ChannelChar&#39;</span><span class="p">,</span>
           <span class="s1">&#39;ChannelData&#39;</span><span class="p">,</span>
           <span class="s1">&#39;ChannelDouble&#39;</span><span class="p">,</span>
           <span class="s1">&#39;ChannelEnum&#39;</span><span class="p">,</span>
           <span class="s1">&#39;ChannelFloat&#39;</span><span class="p">,</span>
           <span class="s1">&#39;ChannelInteger&#39;</span><span class="p">,</span>
           <span class="s1">&#39;ChannelNumeric&#39;</span><span class="p">,</span>
           <span class="s1">&#39;ChannelShort&#39;</span><span class="p">,</span>
           <span class="s1">&#39;ChannelString&#39;</span><span class="p">,</span>
           <span class="s1">&#39;SkipWrite&#39;</span><span class="p">,</span>
           <span class="p">)</span>

<span class="n">SubscriptionUpdate</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;SubscriptionUpdate&#39;</span><span class="p">,</span>
                                <span class="p">(</span><span class="s1">&#39;sub_specs&#39;</span><span class="p">,</span> <span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="s1">&#39;values&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;flags&#39;</span><span class="p">,</span> <span class="s1">&#39;sub&#39;</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">Forbidden</span><span class="p">(</span><span class="n">CaprotoError</span><span class="p">):</span>
    <span class="o">...</span>


<span class="k">class</span> <span class="nc">CannotExceedLimits</span><span class="p">(</span><span class="n">CaprotoValueError</span><span class="p">):</span>
    <span class="o">...</span>


<span class="k">class</span> <span class="nc">SkipWrite</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raise this exception to skip further processing of write().&quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">dbr_metadata_to_dict</span><span class="p">(</span><span class="n">dbr_metadata</span><span class="p">,</span> <span class="n">string_encoding</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Return a dictionary of metadata keys to values&#39;&#39;&#39;</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">dbr_metadata</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">string_encoding</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="k">return</span> <span class="n">info</span>


<span class="k">def</span> <span class="nf">_read_only_property</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Create property that gives read-only access to instance._data[key]&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">doc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Read-only access to </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> data&quot;</span>
    <span class="k">return</span> <span class="nb">property</span><span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">doc</span><span class="o">=</span><span class="n">doc</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ChannelAlarm</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">must_acknowledge_transient</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">severity_to_acknowledge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">alarm_string</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">string_encoding</span><span class="o">=</span><span class="s1">&#39;latin-1&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Alarm metadata that can be used by one or more ChannelData instances.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        status : int or AlarmStatus, optional</span>
<span class="sd">            Status information.</span>
<span class="sd">        severity : int or AlarmSeverity, optional</span>
<span class="sd">            Severity information.</span>
<span class="sd">        must_acknowledge_transient : int, optional</span>
<span class="sd">            Whether or not transient alarms must be acknowledged.</span>
<span class="sd">        severity_to_acknowledge : int, optional</span>
<span class="sd">            The highest alarm severity to acknowledge. If the current alarm</span>
<span class="sd">            severity is less then or equal to this value the alarm is</span>
<span class="sd">            acknowledged.</span>
<span class="sd">        alarm_string : str, optional</span>
<span class="sd">            Alarm information.</span>
<span class="sd">        string_encoding : str, optional</span>
<span class="sd">            String encoding of the alarm string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakSet</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">string_encoding</span> <span class="o">=</span> <span class="n">string_encoding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="n">severity</span><span class="p">,</span>
            <span class="n">must_acknowledge_transient</span><span class="o">=</span><span class="n">must_acknowledge_transient</span><span class="p">,</span>
            <span class="n">severity_to_acknowledge</span><span class="o">=</span><span class="n">severity_to_acknowledge</span><span class="p">,</span>
            <span class="n">alarm_string</span><span class="o">=</span><span class="n">alarm_string</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getnewargs_ex__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
            <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">severity</span><span class="p">,</span>
            <span class="s1">&#39;must_acknowledge_transient&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">must_acknowledge_transient</span><span class="p">,</span>
            <span class="s1">&#39;severity_to_acknowledge&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">severity_to_acknowledge</span><span class="p">,</span>
            <span class="s1">&#39;alarm_string&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">alarm_string</span><span class="p">,</span>
            <span class="s1">&#39;string_encoding&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">string_encoding</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="p">((),</span> <span class="n">kwargs</span><span class="p">)</span>

    <span class="n">status</span> <span class="o">=</span> <span class="n">_read_only_property</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span>
                                 <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Current alarm status&#39;</span><span class="p">)</span>
    <span class="n">severity</span> <span class="o">=</span> <span class="n">_read_only_property</span><span class="p">(</span><span class="s1">&#39;severity&#39;</span><span class="p">,</span>
                                   <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Current alarm severity&#39;</span><span class="p">)</span>
    <span class="n">must_acknowledge_transient</span> <span class="o">=</span> <span class="n">_read_only_property</span><span class="p">(</span>
        <span class="s1">&#39;must_acknowledge_transient&#39;</span><span class="p">,</span>
        <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Toggle whether or not transient alarms must be acknowledged&#39;</span><span class="p">)</span>

    <span class="n">severity_to_acknowledge</span> <span class="o">=</span> <span class="n">_read_only_property</span><span class="p">(</span>
        <span class="s1">&#39;severity_to_acknowledge&#39;</span><span class="p">,</span>
        <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;The alarm severity that has been acknowledged&#39;</span><span class="p">)</span>

    <span class="n">alarm_string</span> <span class="o">=</span> <span class="n">_read_only_property</span><span class="p">(</span><span class="s1">&#39;alarm_string&#39;</span><span class="p">,</span>
                                       <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;String associated with alarm&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;ChannelAlarm(status=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s1">, severity=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">severity</span><span class="si">}</span><span class="s1">)&gt;&#39;</span>

    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a ChannelData instance to the channel set using this alarm.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">channel_data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove ChannelData instance from channel set using this alarm.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">channel_data</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read alarm information into a DBR_STSACK_STRING instance.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dbr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dbr</span> <span class="o">=</span> <span class="n">DBR_STSACK_STRING</span><span class="p">()</span>
        <span class="n">dbr</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span>
        <span class="n">dbr</span><span class="o">.</span><span class="n">severity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">severity</span>
        <span class="n">dbr</span><span class="o">.</span><span class="n">ackt</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">must_acknowledge_transient</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">dbr</span><span class="o">.</span><span class="n">acks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">severity_to_acknowledge</span>
        <span class="n">dbr</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alarm_string</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">string_encoding</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dbr</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">must_acknowledge_transient</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">severity_to_acknowledge</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">alarm_string</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">publish</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write data to the alarm and optionally publish it to clients.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        status : int or AlarmStatus, optional</span>
<span class="sd">            Status information.</span>
<span class="sd">        severity : int or AlarmSeverity, optional</span>
<span class="sd">            Severity information.</span>
<span class="sd">        must_acknowledge_transient : int, optional</span>
<span class="sd">            Whether or not transient alarms must be acknowledged.</span>
<span class="sd">        severity_to_acknowledge : int, optional</span>
<span class="sd">            The highest alarm severity to acknowledge. If the current alarm</span>
<span class="sd">            severity is less then or equal to this value the alarm is</span>
<span class="sd">            acknowledged.</span>
<span class="sd">        alarm_string : str, optional</span>
<span class="sd">            Alarm information.</span>
<span class="sd">        flags : SubscriptionType or int, optional</span>
<span class="sd">            Subscription flags.</span>
<span class="sd">        publish : bool, optional</span>
<span class="sd">            Optionally publish the alarm status after the write.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>

        <span class="k">if</span> <span class="n">status</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AlarmStatus</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">SubscriptionType</span><span class="o">.</span><span class="n">DBE_VALUE</span>

        <span class="k">if</span> <span class="n">severity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;severity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AlarmSeverity</span><span class="p">(</span><span class="n">severity</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">must_acknowledge_transient</span> <span class="ow">or</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">severity_to_acknowledge</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">severity</span><span class="p">):</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;severity_to_acknowledge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">severity</span>

            <span class="n">flags</span> <span class="o">|=</span> <span class="n">SubscriptionType</span><span class="o">.</span><span class="n">DBE_ALARM</span>

        <span class="k">if</span> <span class="n">must_acknowledge_transient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;must_acknowledge_transient&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">must_acknowledge_transient</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">must_acknowledge_transient</span> <span class="ow">and</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">severity_to_acknowledge</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">severity</span><span class="p">):</span>
                <span class="c1"># Reset the severity to acknowledge if disabling transient</span>
                <span class="c1"># requirement</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;severity_to_acknowledge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">severity</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">SubscriptionType</span><span class="o">.</span><span class="n">DBE_ALARM</span>

        <span class="k">if</span> <span class="n">severity_to_acknowledge</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># To clear, set greater than or equal to the</span>
            <span class="c1"># severity_to_acknowledge</span>
            <span class="k">if</span> <span class="n">severity_to_acknowledge</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">severity</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;severity_to_acknowledge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">flags</span> <span class="o">|=</span> <span class="n">SubscriptionType</span><span class="o">.</span><span class="n">DBE_ALARM</span>

        <span class="k">if</span> <span class="n">alarm_string</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;alarm_string&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alarm_string</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">SubscriptionType</span><span class="o">.</span><span class="n">DBE_ALARM</span>

        <span class="k">if</span> <span class="n">publish</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">publish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">except_for</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Publish alarm information to all listening channels.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        flags : SubscriptionType</span>
<span class="sd">            The subscription type to publish.</span>
<span class="sd">        except_for : sequence of ChannelData, optional</span>
<span class="sd">            Skip publishing to these channels, mainly to avoid recursion.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">except_for</span> <span class="o">=</span> <span class="n">except_for</span> <span class="ow">or</span> <span class="p">()</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">channel</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">except_for</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">channel</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>


<div class="viewcode-block" id="ChannelData"><a class="viewcode-back" href="../../generated/caproto._data.ChannelData.html#caproto.ChannelData">[docs]</a><span class="k">class</span> <span class="nc">ChannelData</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class holding data and metadata which can be sent across a Channel.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    value :</span>
<span class="sd">        Data which has to match with this class&#39;s ``data_type``.</span>
<span class="sd">    timestamp : float, optional</span>
<span class="sd">        Posix timestamp associated with the value. Defaults to ``time.time()``.</span>
<span class="sd">    max_length : int, optional</span>
<span class="sd">        Maximum array length of the data.</span>
<span class="sd">    string_encoding : str, optional</span>
<span class="sd">        Encoding to use for strings, used when serializing and deserializing</span>
<span class="sd">        data.</span>
<span class="sd">    reported_record_type : str, optional</span>
<span class="sd">        Though this is not a record, the channel access protocol supports</span>
<span class="sd">        querying the record type.  This can be set to mimic an actual</span>
<span class="sd">        record or be set to something arbitrary.  Defaults to &#39;caproto&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data_type</span> <span class="o">=</span> <span class="n">ChannelType</span><span class="o">.</span><span class="n">LONG</span>
    <span class="n">_compatible_array_types</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">alarm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">max_length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">string_encoding</span><span class="o">=</span><span class="s1">&#39;latin-1&#39;</span><span class="p">,</span>
                 <span class="n">reported_record_type</span><span class="o">=</span><span class="s1">&#39;caproto&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">timestamp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">alarm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">alarm</span> <span class="o">=</span> <span class="n">ChannelAlarm</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_alarm</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_severity</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># now use the setter to attach the alarm correctly:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alarm</span> <span class="o">=</span> <span class="n">alarm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_length</span> <span class="o">=</span> <span class="n">max_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">string_encoding</span> <span class="o">=</span> <span class="n">string_encoding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reported_record_type</span> <span class="o">=</span> <span class="n">reported_record_type</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Use the current length as maximum, if unspecified.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_max_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calculate_length</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
            <span class="c1"># It is possible to pass in a zero-length array to start with.</span>
            <span class="c1"># However, it is not useful to have an empty value forever, so the</span>
            <span class="c1"># minimum length here is required to be at least 1.</span>

        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                          <span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span><span class="p">)</span>
        <span class="c1"># This is a dict keyed on queues that will receive subscription</span>
        <span class="c1"># updates.  (Each queue belongs to a Context.) Each value is itself a</span>
        <span class="c1"># dict, mapping data_types to the set of SubscriptionSpecs that request</span>
        <span class="c1"># that data_type.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_queues</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)))</span>

        <span class="c1"># Cache results of data_type conversions. This maps data_type to</span>
        <span class="c1"># (metdata, value). This is cleared each time publish() is called.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_content</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fill_at_next_write</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">calculate_length</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="s1">&#39;Calculate the number of elements given a value&#39;</span>
        <span class="n">is_array</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="o">+</span> <span class="n">backend</span><span class="o">.</span><span class="n">array_types</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_array</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_type</span> <span class="o">==</span> <span class="n">ChannelType</span><span class="o">.</span><span class="n">CHAR</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">length</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;The number of elements (length) of the current value&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_length</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">max_length</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;The maximum number of elements (length) this channel can hold&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_length</span>

    <span class="k">def</span> <span class="nf">preprocess_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Pre-process values destined for verify_value and write</span>

<span class="sd">        A few basic things are done here, based on max_count:</span>
<span class="sd">        1. If length &gt;= 2, ensure the value is a list</span>
<span class="sd">        2. If length == 1, ensure the value is an unpacked scalar</span>
<span class="sd">        3. Ensure len(value) &lt;= length</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        CaprotoValueError</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">is_array</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="o">+</span> <span class="n">backend</span><span class="o">.</span><span class="n">array_types</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_array</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_length</span><span class="p">:</span>
                <span class="c1"># TODO consider an exception for caproto-only environments that</span>
                <span class="c1"># can handle dynamically resized arrays (i.e., sizes greater</span>
                <span class="c1"># than the initial max_length)?</span>
                <span class="k">raise</span> <span class="n">CaprotoValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Value of length </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s1"> is too large for &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">(max_length=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_length</span><span class="si">}</span><span class="s1">)&#39;</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_array</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                    <span class="c1"># scalar value in a list -&gt; scalar value</span>
                    <span class="k">return</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">raise</span> <span class="n">CaprotoValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Cannot set a scalar to an empty array&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">is_array</span><span class="p">:</span>
            <span class="c1"># scalar value that should be in a list -&gt; list</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">__getnewargs_ex__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># ref: https://docs.python.org/3/library/pickle.html</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span>
                  <span class="s1">&#39;alarm&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">alarm</span><span class="p">,</span>
                  <span class="s1">&#39;string_encoding&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">string_encoding</span><span class="p">,</span>
                  <span class="s1">&#39;reported_record_type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reported_record_type</span><span class="p">,</span>
                  <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span>
                  <span class="s1">&#39;max_length&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_length</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">((),</span> <span class="n">kwargs</span><span class="p">)</span>

    <span class="n">value</span> <span class="o">=</span> <span class="n">_read_only_property</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">_read_only_property</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">)</span>

    <span class="c1"># &quot;before&quot; — only the last value received before the state changes from</span>
    <span class="c1">#     false to true is forwarded to the client.</span>
    <span class="c1"># &quot;first&quot; — only the first value received after the state changes from true</span>
    <span class="c1">#     to false is forwarded to the client.</span>
    <span class="c1"># &quot;while&quot; — values are forwarded to the client as long as the state is true.</span>
    <span class="c1"># &quot;last&quot; — only the last value received before the state changes from true</span>
    <span class="c1">#     to false is forwarded to the client.</span>
    <span class="c1"># &quot;after&quot; — only the first value received after the state changes from true</span>
    <span class="c1">#     to false is forwarded to the client.</span>
    <span class="c1"># &quot;unless&quot; — values are forwarded to the client as long as the state is</span>
    <span class="c1">#     false.</span>

    <span class="k">def</span> <span class="nf">pre_state_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">new_value</span><span class="p">):</span>
        <span class="s2">&quot;This is called by the server when it enters its StateUpdateContext.&quot;</span>
        <span class="n">snapshots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">[</span><span class="n">state</span><span class="p">]</span>
        <span class="n">snapshots</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">snapshot</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_value</span><span class="p">:</span>
            <span class="c1"># We are changing from false to true.</span>
            <span class="n">snapshots</span><span class="p">[</span><span class="s1">&#39;before&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">snapshot</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># We are changing from true to false.</span>
            <span class="n">snapshots</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">snapshot</span>

    <span class="k">def</span> <span class="nf">post_state_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">new_value</span><span class="p">):</span>
        <span class="s2">&quot;This is called by the server when it exits its StateUpdateContext.&quot;</span>
        <span class="n">snapshots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">[</span><span class="n">state</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">new_value</span><span class="p">:</span>
            <span class="c1"># We have changed from false to true.</span>
            <span class="n">snapshots</span><span class="p">[</span><span class="s1">&#39;while&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fill_at_next_write</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">state</span><span class="p">,</span> <span class="s1">&#39;after&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># We have changed from true to false.</span>
            <span class="n">snapshots</span><span class="p">[</span><span class="s1">&#39;unless&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fill_at_next_write</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">state</span><span class="p">,</span> <span class="s1">&#39;first&#39;</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">alarm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;The ChannelAlarm associated with this data&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alarm</span>

    <span class="nd">@alarm</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">alarm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alarm</span><span class="p">):</span>
        <span class="n">old_alarm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alarm</span>
        <span class="k">if</span> <span class="n">old_alarm</span> <span class="ow">is</span> <span class="n">alarm</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">old_alarm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">old_alarm</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_alarm</span> <span class="o">=</span> <span class="n">alarm</span>
        <span class="k">if</span> <span class="n">alarm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">alarm</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">subscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">sub_spec</span><span class="p">,</span> <span class="n">sub</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Subscribe a queue for the given subscription specification.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        queue : asyncio.Queue or compatible</span>
<span class="sd">            The queue to send data to.</span>
<span class="sd">        sub_spec : SubscriptionSpec</span>
<span class="sd">            The matching subscription specification.</span>
<span class="sd">        sub : Subscription</span>
<span class="sd">            The subscription instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">by_sync</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queues</span><span class="p">[</span><span class="n">queue</span><span class="p">][</span><span class="n">sub_spec</span><span class="o">.</span><span class="n">channel_filter</span><span class="o">.</span><span class="n">sync</span><span class="p">]</span>
        <span class="n">by_sync</span><span class="p">[</span><span class="n">sub_spec</span><span class="o">.</span><span class="n">data_type_name</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sub_spec</span><span class="p">)</span>

        <span class="c1"># Always send current reading immediately upon subscription.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metadata</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_content</span><span class="p">[</span><span class="n">sub_spec</span><span class="o">.</span><span class="n">data_type_name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># Do the expensive data type conversion and cache it in case</span>
            <span class="c1"># a future subscription wants the same data type.</span>
            <span class="n">data_type</span> <span class="o">=</span> <span class="n">_channel_type_by_name</span><span class="p">[</span><span class="n">sub_spec</span><span class="o">.</span><span class="n">data_type_name</span><span class="p">]</span>
            <span class="n">metadata</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">(</span><span class="n">data_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_content</span><span class="p">[</span><span class="n">sub_spec</span><span class="o">.</span><span class="n">data_type_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">values</span>
        <span class="k">await</span> <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">SubscriptionUpdate</span><span class="p">((</span><span class="n">sub_spec</span><span class="p">,),</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sub</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">unsubscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">sub_spec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Unsubscribe a queue for the given subscription specification.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        queue : asyncio.Queue or compatible</span>
<span class="sd">            The queue to send data to.</span>
<span class="sd">        sub_spec : SubscriptionSpec</span>
<span class="sd">            The subscription specification.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">by_sync</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queues</span><span class="p">[</span><span class="n">queue</span><span class="p">][</span><span class="n">sub_spec</span><span class="o">.</span><span class="n">channel_filter</span><span class="o">.</span><span class="n">sync</span><span class="p">]</span>
        <span class="n">by_sync</span><span class="p">[</span><span class="n">sub_spec</span><span class="o">.</span><span class="n">data_type_name</span><span class="p">]</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">sub_spec</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">auth_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">data_type</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
                        <span class="n">user_address</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get DBR data and native data, converted to a specific type&#39;&#39;&#39;</span>
        <span class="n">access</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_access</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">AccessRights</span><span class="o">.</span><span class="n">READ</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">access</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Forbidden</span><span class="p">(</span><span class="s2">&quot;Client with hostname </span><span class="si">{}</span><span class="s2"> and username </span><span class="si">{}</span><span class="s2"> cannot &quot;</span>
                            <span class="s2">&quot;read.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">username</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">(</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">data_type</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read out the ChannelData as ``data_type``.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_type : ChannelType</span>
<span class="sd">            The data type to read out.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Subclass might trigger a write here to update self._data before</span>
        <span class="c1"># reading it out.</span>
        <span class="k">return</span> <span class="p">(</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">(</span><span class="n">data_type</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inner method to read out the ChannelData as ``data_type``.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_type : ChannelType</span>
<span class="sd">            The data type to read out.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># special cases for alarm strings and class name</span>
        <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="n">ChannelType</span><span class="o">.</span><span class="n">STSACK_STRING</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">alarm</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data_type</span> <span class="o">==</span> <span class="n">ChannelType</span><span class="o">.</span><span class="n">CLASS_NAME</span><span class="p">:</span>
            <span class="n">class_name</span> <span class="o">=</span> <span class="n">DBR_TYPES</span><span class="p">[</span><span class="n">data_type</span><span class="p">]()</span>
            <span class="n">rtyp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reported_record_type</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">string_encoding</span><span class="p">)</span>
            <span class="n">class_name</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">rtyp</span>
            <span class="k">return</span> <span class="n">class_name</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="n">data_type</span> <span class="ow">in</span> <span class="n">_LongStringChannelType</span><span class="p">:</span>
            <span class="n">native_to</span> <span class="o">=</span> <span class="n">_LongStringChannelType</span><span class="o">.</span><span class="n">LONG_STRING</span>
            <span class="n">data_type</span> <span class="o">=</span> <span class="n">ChannelType</span><span class="p">(</span><span class="n">data_type</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">native_to</span> <span class="o">=</span> <span class="n">native_type</span><span class="p">(</span><span class="n">data_type</span><span class="p">)</span>

        <span class="n">values</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">convert_values</span><span class="p">(</span>
            <span class="n">values</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span>
            <span class="n">from_dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_type</span><span class="p">,</span>
            <span class="n">to_dtype</span><span class="o">=</span><span class="n">native_to</span><span class="p">,</span>
            <span class="n">string_encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">string_encoding</span><span class="p">,</span>
            <span class="n">enum_strings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;enum_strings&#39;</span><span class="p">),</span>
            <span class="n">direction</span><span class="o">=</span><span class="n">ConversionDirection</span><span class="o">.</span><span class="n">TO_WIRE</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># for native types, there is no dbr metadata - just data</span>
        <span class="k">if</span> <span class="n">data_type</span> <span class="ow">in</span> <span class="n">native_types</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">values</span>

        <span class="n">dbr_metadata</span> <span class="o">=</span> <span class="n">DBR_TYPES</span><span class="p">[</span><span class="n">data_type</span><span class="p">]()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_metadata</span><span class="p">(</span><span class="n">dbr_metadata</span><span class="p">)</span>

        <span class="c1"># Copy alarm fields also.</span>
        <span class="n">alarm_dbr</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">alarm</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">alarm_dbr</span><span class="o">.</span><span class="n">_fields_</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dbr_metadata</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">dbr_metadata</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">alarm_dbr</span><span class="p">,</span> <span class="n">field</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">dbr_metadata</span><span class="p">,</span> <span class="n">values</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">auth_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_type</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
                         <span class="o">*</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">user_address</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Data write hook for clients.</span>

<span class="sd">        First verifies that the specified client may write to the instance</span>
<span class="sd">        prior to proceeding.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        hostname : str</span>
<span class="sd">            The hostname of the client.</span>
<span class="sd">        username : str</span>
<span class="sd">            The username of the client.</span>
<span class="sd">        data :</span>
<span class="sd">            The data to write.</span>
<span class="sd">        data_type : ChannelType</span>
<span class="sd">            The data type associated with the written data.</span>
<span class="sd">        metadata :</span>
<span class="sd">            Metadata instance.</span>
<span class="sd">        flags : int, optional</span>
<span class="sd">            Flags for publishing.</span>
<span class="sd">        user_address : tuple, optional</span>
<span class="sd">            (host, port) tuple of the user.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        Forbidden:</span>
<span class="sd">            If client is not allowed to write to this instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">access</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_access</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">AccessRights</span><span class="o">.</span><span class="n">WRITE</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">access</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Forbidden</span><span class="p">(</span><span class="s2">&quot;Client with hostname </span><span class="si">{}</span><span class="s2"> and username </span><span class="si">{}</span><span class="s2"> cannot &quot;</span>
                            <span class="s2">&quot;write.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">username</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">(</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_from_dbr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data_type</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
                                          <span class="n">flags</span><span class="o">=</span><span class="n">flags</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">verify_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify a value prior to it being written by CA or Python</span>

<span class="sd">        To reject a value, raise an exception. Otherwise, return the</span>
<span class="sd">        original value or a modified version of it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">write_from_dbr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_type</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write data from a provided DBR data type.</span>

<span class="sd">        Does not verify the client has authorization to write.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data :</span>
<span class="sd">            The data to write.</span>
<span class="sd">        data_type : ChannelType</span>
<span class="sd">            The data type associated with the written data.</span>
<span class="sd">        metadata :</span>
<span class="sd">            Metadata instance.</span>
<span class="sd">        flags : int, optional</span>
<span class="sd">            Flags for publishing.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        CaprotoValueError:</span>
<span class="sd">            If the request is not valid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="n">ChannelType</span><span class="o">.</span><span class="n">PUT_ACKS</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">alarm</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">severity_to_acknowledge</span><span class="o">=</span><span class="n">metadata</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">data_type</span> <span class="o">==</span> <span class="n">ChannelType</span><span class="o">.</span><span class="n">PUT_ACKT</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">alarm</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">must_acknowledge_transient</span><span class="o">=</span><span class="n">metadata</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">data_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ChannelType</span><span class="o">.</span><span class="n">STSACK_STRING</span><span class="p">,</span> <span class="n">ChannelType</span><span class="o">.</span><span class="n">CLASS_NAME</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CaprotoValueError</span><span class="p">(</span><span class="s1">&#39;Bad request&#39;</span><span class="p">)</span>

        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">native_from</span> <span class="o">=</span> <span class="n">native_type</span><span class="p">(</span><span class="n">data_type</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">convert_values</span><span class="p">(</span>
            <span class="n">values</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">from_dtype</span><span class="o">=</span><span class="n">native_from</span><span class="p">,</span>
            <span class="n">to_dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_type</span><span class="p">,</span>
            <span class="n">string_encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">string_encoding</span><span class="p">,</span>
            <span class="n">enum_strings</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;enum_strings&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="n">direction</span><span class="o">=</span><span class="n">ConversionDirection</span><span class="o">.</span><span class="n">FROM_WIRE</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">metadata_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Convert `metadata` to bytes-like (or pass it through).</span>
            <span class="n">md_payload</span> <span class="o">=</span> <span class="n">parse_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">data_type</span><span class="p">)</span>

            <span class="c1"># Depending on the type of `metadata` above,</span>
            <span class="c1"># `md_payload` could be a DBR struct or plain bytes.</span>
            <span class="c1"># Load it into a struct (zero-copy) to be sure.</span>
            <span class="n">dbr_metadata</span> <span class="o">=</span> <span class="n">DBR_TYPES</span><span class="p">[</span><span class="n">data_type</span><span class="p">]</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">md_payload</span><span class="p">)</span>
            <span class="n">metadata_dict</span> <span class="o">=</span> <span class="n">dbr_metadata_to_dict</span><span class="p">(</span><span class="n">dbr_metadata</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">string_encoding</span><span class="p">)</span>
            <span class="n">metadata_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">flags</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata_dict</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verify_value</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">update_fields</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write data from native Python types.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        value :</span>
<span class="sd">            The native Python data.</span>
<span class="sd">        flags : SubscriptionType or int, optional</span>
<span class="sd">            The flags for subscribers.</span>
<span class="sd">        verify_value : bool, optional</span>
<span class="sd">            Run the ``verify_value`` hook prior to updating internal state.</span>
<span class="sd">        update_fields : bool, optional</span>
<span class="sd">            Run the ``update_fields`` hook prior to updating internal state.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        Exception:</span>
<span class="sd">            Any exception raised in the handlers (except SkipWrite) will be</span>
<span class="sd">            propagated to the caller.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verify_value</span><span class="p">:</span>
                <span class="n">modified_value</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">modified_value</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">update_fields</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_fields</span><span class="p">(</span>
                    <span class="n">modified_value</span> <span class="k">if</span> <span class="n">verify_value</span> <span class="k">else</span> <span class="n">value</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="n">SkipWrite</span><span class="p">:</span>
            <span class="c1"># Handler raised SkipWrite to avoid the rest of this method.</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="ne">GeneratorExit</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># TODO: should allow exception to optionally pass alarm</span>
            <span class="c1"># status/severity through exception instance</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">alarm</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">AlarmStatus</span><span class="o">.</span><span class="n">WRITE</span><span class="p">,</span>
                                   <span class="n">severity</span><span class="o">=</span><span class="n">AlarmSeverity</span><span class="o">.</span><span class="n">MAJOR_ALARM</span><span class="p">,</span>
                                   <span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">alarm_md</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_alarm</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">modified_value</span> <span class="ow">is</span> <span class="n">SkipWrite</span><span class="p">:</span>
            <span class="c1"># An alternative to raising SkipWrite: avoid the rest of this</span>
            <span class="c1"># method.</span>
            <span class="k">return</span>

        <span class="c1"># issues of over-riding user passed in data here!</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">alarm_md</span><span class="p">)</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fill_at_next_write</span><span class="p">:</span>
            <span class="n">snapshot</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">state</span><span class="p">,</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fill_at_next_write</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">[</span><span class="n">state</span><span class="p">][</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="n">snapshot</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fill_at_next_write</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="n">new</span> <span class="o">=</span> <span class="n">modified_value</span> <span class="k">if</span> <span class="n">modified_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">value</span>

        <span class="c1"># TODO the next 5 lines should be done in one move</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_metadata</span><span class="p">(</span><span class="n">publish</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span>
        <span class="c1"># Send a new event to subscribers.</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>
        <span class="c1"># and publish any linked alarms</span>
        <span class="k">if</span> <span class="s1">&#39;status&#39;</span> <span class="ow">in</span> <span class="n">metadata</span> <span class="ow">or</span> <span class="s1">&#39;severity&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">alarm</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">except_for</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="p">,))</span>

    <span class="k">def</span> <span class="nf">_is_eligible</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ss</span><span class="p">):</span>
        <span class="n">sync</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">channel_filter</span><span class="o">.</span><span class="n">sync</span>
        <span class="k">return</span> <span class="n">sync</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">sync</span><span class="o">.</span><span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">[</span><span class="n">sync</span><span class="o">.</span><span class="n">s</span><span class="p">]</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">update_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This is a hook for subclasses to update field instance data.&quot;&quot;&quot;</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">publish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flags</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Publish data to appropriate queues matching the SubscriptionSpec.</span>

<span class="sd">        Each SubscriptionSpec specifies a certain data type it is interested in</span>
<span class="sd">        and a mask. Send one update per queue per data_type if and only if any</span>
<span class="sd">        subscriptions specs on a queue have a compatible mask.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        flags : SubscriptionSpec</span>
<span class="sd">            The subscription specification to match.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Copying the data into structs with various data types is expensive,</span>
        <span class="c1"># so we only want to do it if it&#39;s going to be used, and we only want</span>
        <span class="c1"># to do each conversion once. Clear the cache to start. This cache is</span>
        <span class="c1"># instance state so that self.subscribe can also use it.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_content</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">queue</span><span class="p">,</span> <span class="n">syncs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queues</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># queue belongs to a Context that is expecting to receive</span>
            <span class="c1"># updates of the form (sub_specs, metadata, values).</span>
            <span class="c1"># data_types is a dict grouping the sub_specs for this queue by</span>
            <span class="c1"># their data_type.</span>
            <span class="k">for</span> <span class="n">sync</span><span class="p">,</span> <span class="n">data_types</span> <span class="ow">in</span> <span class="n">syncs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">data_type_name</span><span class="p">,</span> <span class="n">sub_specs</span> <span class="ow">in</span> <span class="n">data_types</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">eligible</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ss</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">sub_specs</span>
                                     <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_eligible</span><span class="p">(</span><span class="n">ss</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">eligible</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">sync</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">channel_data</span> <span class="o">=</span> <span class="bp">self</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">channel_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">[</span><span class="n">sync</span><span class="o">.</span><span class="n">s</span><span class="p">][</span><span class="n">sync</span><span class="o">.</span><span class="n">m</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="k">continue</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">metdata</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_content</span><span class="p">[</span><span class="n">data_type_name</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="c1"># Do the expensive data type conversion and cache it in</span>
                        <span class="c1"># case another queue or a future subscription wants the</span>
                        <span class="c1"># same data type.</span>
                        <span class="n">data_type</span> <span class="o">=</span> <span class="n">_channel_type_by_name</span><span class="p">[</span><span class="n">data_type_name</span><span class="p">]</span>
                        <span class="n">metadata</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="k">await</span> <span class="n">channel_data</span><span class="o">.</span><span class="n">_read</span><span class="p">(</span><span class="n">data_type</span><span class="p">)</span>
                        <span class="n">channel_data</span><span class="o">.</span><span class="n">_content</span><span class="p">[</span><span class="n">data_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">values</span>

                    <span class="c1"># We will apply the array filter and deadband on the other side</span>
                    <span class="c1"># of the queue, since each eligible SubscriptionSpec may</span>
                    <span class="c1"># want a different slice. Sending the whole array through</span>
                    <span class="c1"># the queue isn&#39;t any more expensive that sending a slice;</span>
                    <span class="c1"># this is just a reference.</span>
                    <span class="k">await</span> <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">SubscriptionUpdate</span><span class="p">(</span><span class="n">eligible</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_read_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbr_metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fill the provided metadata instance with current metadata.&quot;&quot;&quot;</span>
        <span class="n">to_type</span> <span class="o">=</span> <span class="n">ChannelType</span><span class="p">(</span><span class="n">dbr_metadata</span><span class="o">.</span><span class="n">DBR_ID</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dbr_metadata</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">):</span>
            <span class="n">units</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;units&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">units</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">string_encoding</span>
                                     <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">string_encoding</span>
                                     <span class="k">else</span> <span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>
            <span class="n">dbr_metadata</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">units</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dbr_metadata</span><span class="p">,</span> <span class="s1">&#39;precision&#39;</span><span class="p">):</span>
            <span class="n">dbr_metadata</span><span class="o">.</span><span class="n">precision</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;precision&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">to_type</span> <span class="ow">in</span> <span class="n">time_types</span><span class="p">:</span>
            <span class="n">epics_ts</span> <span class="o">=</span> <span class="n">timestamp_to_epics</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">])</span>
            <span class="n">stamp</span> <span class="o">=</span> <span class="n">dbr_metadata</span><span class="o">.</span><span class="n">stamp</span>
            <span class="n">stamp</span><span class="o">.</span><span class="n">secondsSinceEpoch</span><span class="p">,</span> <span class="n">stamp</span><span class="o">.</span><span class="n">nanoSeconds</span> <span class="o">=</span> <span class="n">epics_ts</span>

        <span class="n">convert_attrs</span> <span class="o">=</span> <span class="p">(</span><span class="n">GraphicControlBase</span><span class="o">.</span><span class="n">control_fields</span> <span class="o">+</span>
                         <span class="n">GraphicControlBase</span><span class="o">.</span><span class="n">graphic_fields</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">dbr_metadata</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">convert_attrs</span><span class="p">):</span>
            <span class="c1"># convert all metadata types to the target type</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_type</span>
                  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_type</span> <span class="o">!=</span> <span class="n">ChannelType</span><span class="o">.</span><span class="n">ENUM</span>
                  <span class="k">else</span> <span class="n">ChannelType</span><span class="o">.</span><span class="n">INT</span><span class="p">)</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">convert_values</span><span class="p">(</span>
                <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">convert_attrs</span><span class="p">],</span>
                <span class="n">from_dtype</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span>
                <span class="n">to_dtype</span><span class="o">=</span><span class="n">native_type</span><span class="p">(</span><span class="n">to_type</span><span class="p">),</span>
                <span class="n">string_encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">string_encoding</span><span class="p">,</span>
                <span class="n">direction</span><span class="o">=</span><span class="n">ConversionDirection</span><span class="o">.</span><span class="n">TO_WIRE</span><span class="p">,</span>
                <span class="n">auto_byteswap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">backend</span><span class="o">.</span><span class="n">array_types</span><span class="p">):</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">convert_attrs</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dbr_metadata</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">dbr_metadata</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">write_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">publish</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">timestamp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">upper_disp_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">lower_disp_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">upper_alarm_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">upper_warning_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">lower_warning_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lower_alarm_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">upper_ctrl_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lower_ctrl_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">status</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write metadata, optionally publishing information to clients.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        publish : bool, optional</span>
<span class="sd">            Publish the metadata update to clients.</span>
<span class="sd">        units : str, optional</span>
<span class="sd">            Updated units.</span>
<span class="sd">        precision : int, optional</span>
<span class="sd">            Updated precision value.</span>
<span class="sd">        timestamp : float, optional</span>
<span class="sd">            Updated timestamp.</span>
<span class="sd">        upper_disp_limit : int or float, optional</span>
<span class="sd">            Updated upper display limit.</span>
<span class="sd">        lower_disp_limit : int or float, optional</span>
<span class="sd">            Updated lower display limit.</span>
<span class="sd">        upper_alarm_limit : int or float, optional</span>
<span class="sd">            Updated upper alarm limit.</span>
<span class="sd">        upper_warning_limit : int or float, optional</span>
<span class="sd">            Updated upper warning limit.</span>
<span class="sd">        lower_warning_limit : int or float, optional</span>
<span class="sd">            Updated lower warning limit.</span>
<span class="sd">        lower_alarm_limit : int or float, optional</span>
<span class="sd">            Updated lower alarm limit.</span>
<span class="sd">        upper_ctrl_limit : int or float, optional</span>
<span class="sd">            Updated upper control limit.</span>
<span class="sd">        lower_ctrl_limit : int or float, optional</span>
<span class="sd">            Updated lower control limit.</span>
<span class="sd">        status : AlarmStatus, optional</span>
<span class="sd">            Updated alarm status.</span>
<span class="sd">        severity : AlarmSeverity, optional</span>
<span class="sd">            Updated alarm severity.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
        <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;units&#39;</span><span class="p">,</span> <span class="s1">&#39;precision&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;upper_disp_limit&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;lower_disp_limit&#39;</span><span class="p">,</span> <span class="s1">&#39;upper_alarm_limit&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;upper_warning_limit&#39;</span><span class="p">,</span> <span class="s1">&#39;lower_warning_limit&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;lower_alarm_limit&#39;</span><span class="p">,</span> <span class="s1">&#39;upper_ctrl_limit&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;lower_ctrl_limit&#39;</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()[</span><span class="n">kw</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="c1"># Unpack scalars. This could be skipped for numpy.ndarray which</span>
                <span class="c1"># does the right thing, but is essential for array.array to</span>
                <span class="c1"># work.</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">value</span><span class="p">,</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                    <span class="k">pass</span>
                <span class="n">data</span><span class="p">[</span><span class="n">kw</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">alarm_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
               <span class="k">for</span> <span class="n">alarm_val</span> <span class="ow">in</span> <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">severity</span><span class="p">)):</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">alarm</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="n">severity</span><span class="p">,</span>
                                   <span class="n">publish</span><span class="o">=</span><span class="n">publish</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">publish</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">SubscriptionType</span><span class="o">.</span><span class="n">DBE_PROPERTY</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">epics_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;EPICS timestamp as (seconds, nanoseconds) since EPICS epoch&#39;</span>
        <span class="k">return</span> <span class="n">timestamp_to_epics</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Alarm status&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alarm</span><span class="o">.</span><span class="n">status</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="p">)</span>

    <span class="nd">@status</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">AlarmStatus</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">severity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Alarm severity&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alarm</span><span class="o">.</span><span class="n">severity</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_severity</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_severity</span><span class="p">)</span>

    <span class="nd">@severity</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">severity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_severity</span> <span class="o">=</span> <span class="n">AlarmSeverity</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_collect_alarm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alarm</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_severity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alarm</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s1">&#39;severity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_severity</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_clear_cached_alarms</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">_clear_cached_alarms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_severity</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">check_access</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This always returns ``AccessRights.READ|AccessRights.WRITE``.</span>

<span class="sd">        Subclasses can override to implement access logic using hostname,</span>
<span class="sd">        username and returning one of:</span>
<span class="sd">        (``AccessRights.NO_ACCESS``,</span>
<span class="sd">         ``AccessRights.READ``,</span>
<span class="sd">         ``AccessRights.WRITE``,</span>
<span class="sd">         ``AccessRights.READ|AccessRights.WRITE``).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        hostname : string</span>
<span class="sd">        username : string</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        access : :data:`AccessRights.READ|AccessRights.WRITE`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">AccessRights</span><span class="o">.</span><span class="n">READ</span> <span class="o">|</span> <span class="n">AccessRights</span><span class="o">.</span><span class="n">WRITE</span>

    <span class="k">def</span> <span class="nf">is_compatible_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the provided value is a compatible array.</span>

<span class="sd">        This requires that ``value`` follow the &quot;array interface&quot;, as defined by</span>
<span class="sd">        `numpy &lt;https://numpy.org/doc/stable/reference/arrays.interface.html&gt;`_.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        value : any</span>
<span class="sd">            The value to check.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if ``value`` is compatible, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">interface</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;__array_interface__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">interface</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">dimensions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">interface</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="c1"># Ensure it&#39;s 1 dimensional:</span>
            <span class="n">dimensions</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span>
            <span class="c1"># Not strided - which 1D data shouldn&#39;t be anyway...</span>
            <span class="n">interface</span><span class="p">[</span><span class="s1">&#39;strides&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span>
            <span class="c1"># And a compatible array type, defined in the class body:</span>
            <span class="n">interface</span><span class="p">[</span><span class="s1">&#39;typestr&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compatible_array_types</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="ChannelEnum"><a class="viewcode-back" href="../../generated/caproto.ChannelEnum.html#caproto.ChannelEnum">[docs]</a><span class="k">class</span> <span class="nc">ChannelEnum</span><span class="p">(</span><span class="n">ChannelData</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ENUM data which can be sent over a channel.</span>

<span class="sd">    Arrays of ENUM data are not supported.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    value : int or str</span>
<span class="sd">        The string value in the enum, or an integer index of that list.</span>
<span class="sd">    enum_strings : list, tuple, optional</span>
<span class="sd">        Enum strings to be used for the data.</span>
<span class="sd">    timestamp : float, optional</span>
<span class="sd">        Posix timestamp associated with the value. Defaults to ``time.time()``.</span>
<span class="sd">    max_length : int, optional</span>
<span class="sd">        Maximum array length of the data.</span>
<span class="sd">    string_encoding : str, optional</span>
<span class="sd">        Encoding to use for strings, used when serializing and deserializing</span>
<span class="sd">        data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">data_type</span> <span class="o">=</span> <span class="n">ChannelType</span><span class="o">.</span><span class="n">ENUM</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_validate_enum_strings</span><span class="p">(</span><span class="n">enum_strings</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">es</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">MAX_ENUM_STRING_SIZE</span> <span class="k">for</span> <span class="n">es</span> <span class="ow">in</span> <span class="n">enum_strings</span><span class="p">):</span>
            <span class="n">over_length</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">es</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">es</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">es</span> <span class="ow">in</span> <span class="n">enum_strings</span> <span class="k">if</span>
                                <span class="nb">len</span><span class="p">(</span><span class="n">es</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">MAX_ENUM_STRING_SIZE</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The maximum enum string length is </span><span class="si">{</span><span class="n">MAX_ENUM_STRING_SIZE</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="o">+</span>
                   <span class="sa">f</span><span class="s2">&quot;but the strings </span><span class="si">{</span><span class="n">over_length</span><span class="si">}</span><span class="s2"> are too long&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">enum_strings</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAX_ENUM_STATES</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The maximum number of enum states is </span><span class="si">{</span><span class="n">MAX_ENUM_STATES</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="o">+</span>
                             <span class="sa">f</span><span class="s2">&quot;but you passed in </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">enum_strings</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">enum_strings</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">enum_strings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">enum_strings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">enum_strings</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="s1">&#39;enum_strings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_enum_strings</span><span class="p">(</span><span class="n">enum_strings</span><span class="p">)</span>

    <span class="n">enum_strings</span> <span class="o">=</span> <span class="n">_read_only_property</span><span class="p">(</span><span class="s1">&#39;enum_strings&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_raw_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The raw integer value index of the provided enum string.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">enum_strings</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">raw_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The raw integer value index of the enum string.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_raw_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getnewargs_ex__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__getnewargs_ex__</span><span class="p">()</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;enum_strings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enum_strings</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">verify_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">enum_strings</span><span class="p">[</span><span class="n">data</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="o">...</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">_read_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbr_metadata</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dbr_metadata</span><span class="p">,</span> <span class="p">(</span><span class="n">DBR_TYPES</span><span class="p">[</span><span class="n">ChannelType</span><span class="o">.</span><span class="n">GR_ENUM</span><span class="p">],</span>
                                     <span class="n">DBR_TYPES</span><span class="p">[</span><span class="n">ChannelType</span><span class="o">.</span><span class="n">CTRL_ENUM</span><span class="p">])):</span>
            <span class="n">dbr_metadata</span><span class="o">.</span><span class="n">enum_strings</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">string_encoding</span><span class="p">)</span>
                                         <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">enum_strings</span><span class="p">]</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_read_metadata</span><span class="p">(</span><span class="n">dbr_metadata</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SubscriptionType</span><span class="o">.</span><span class="n">DBE_LOG</span> <span class="o">|</span> <span class="n">SubscriptionType</span><span class="o">.</span><span class="n">DBE_VALUE</span><span class="p">)</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">flags</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">write_from_dbr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SubscriptionType</span><span class="o">.</span><span class="n">DBE_LOG</span> <span class="o">|</span> <span class="n">SubscriptionType</span><span class="o">.</span><span class="n">DBE_VALUE</span><span class="p">)</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">write_from_dbr</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">flags</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">write_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enum_strings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">enum_strings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="s1">&#39;enum_strings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_enum_strings</span><span class="p">(</span><span class="n">enum_strings</span><span class="p">)</span>

        <span class="k">return</span> <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">write_metadata</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">ChannelNumeric</span><span class="p">(</span><span class="n">ChannelData</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for numeric data types with limits.</span>

<span class="sd">    May be a single value or an array of values.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    value :</span>
<span class="sd">        Data which has to match with this class&#39;s ``data_type``.</span>
<span class="sd">    timestamp : float, optional</span>
<span class="sd">        Posix timestamp associated with the value. Defaults to ``time.time()``.</span>
<span class="sd">    max_length : int, optional</span>
<span class="sd">        Maximum array length of the data.</span>
<span class="sd">    string_encoding : str, optional</span>
<span class="sd">        Encoding to use for strings, used when serializing and deserializing</span>
<span class="sd">        data.</span>
<span class="sd">    reported_record_type : str, optional</span>
<span class="sd">        Though this is not a record, the channel access protocol supports</span>
<span class="sd">        querying the record type.  This can be set to mimic an actual</span>
<span class="sd">        record or be set to something arbitrary.  Defaults to &#39;caproto&#39;.</span>
<span class="sd">    units : str, optional</span>
<span class="sd">        Engineering units indicator, which can be retrieved over channel</span>
<span class="sd">        access.</span>
<span class="sd">    upper_disp_limit : numeric, optional</span>
<span class="sd">        Upper display limit.</span>
<span class="sd">    lower_disp_limit : numeric, optional</span>
<span class="sd">        Lower display limit.</span>
<span class="sd">    upper_alarm_limit : numeric, optional</span>
<span class="sd">        Upper alarm limit.</span>
<span class="sd">    upper_warning_limit : numeric, optional</span>
<span class="sd">        Upper warning limit.</span>
<span class="sd">    lower_warning_limit : numeric, optional</span>
<span class="sd">        Lower warning limit.</span>
<span class="sd">    lower_alarm_limit : numeric, optional</span>
<span class="sd">        Lower alarm limit.</span>
<span class="sd">    upper_ctrl_limit : numeric, optional</span>
<span class="sd">        Upper control limit.</span>
<span class="sd">    lower_ctrl_limit : numeric, optional</span>
<span class="sd">        Lower control limit.</span>
<span class="sd">    value_atol : numeric, optional</span>
<span class="sd">        Archive tolerance value.</span>
<span class="sd">    log_atol : numeric, optional</span>
<span class="sd">        Log tolerance value.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">upper_disp_limit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">lower_disp_limit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">upper_alarm_limit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">upper_warning_limit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">lower_warning_limit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">lower_alarm_limit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">upper_ctrl_limit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">lower_ctrl_limit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">value_atol</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">log_atol</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="s1">&#39;upper_disp_limit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper_disp_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="s1">&#39;lower_disp_limit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lower_disp_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="s1">&#39;upper_alarm_limit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper_alarm_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="s1">&#39;upper_warning_limit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper_warning_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="s1">&#39;lower_warning_limit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lower_warning_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="s1">&#39;lower_alarm_limit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lower_alarm_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="s1">&#39;upper_ctrl_limit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper_ctrl_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="s1">&#39;lower_ctrl_limit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lower_ctrl_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value_atol</span> <span class="o">=</span> <span class="n">value_atol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_atol</span> <span class="o">=</span> <span class="n">log_atol</span>

    <span class="n">units</span> <span class="o">=</span> <span class="n">_read_only_property</span><span class="p">(</span><span class="s1">&#39;units&#39;</span><span class="p">)</span>

    <span class="n">upper_disp_limit</span> <span class="o">=</span> <span class="n">_read_only_property</span><span class="p">(</span><span class="s1">&#39;upper_disp_limit&#39;</span><span class="p">)</span>
    <span class="n">lower_disp_limit</span> <span class="o">=</span> <span class="n">_read_only_property</span><span class="p">(</span><span class="s1">&#39;lower_disp_limit&#39;</span><span class="p">)</span>

    <span class="n">upper_alarm_limit</span> <span class="o">=</span> <span class="n">_read_only_property</span><span class="p">(</span><span class="s1">&#39;upper_alarm_limit&#39;</span><span class="p">)</span>
    <span class="n">lower_alarm_limit</span> <span class="o">=</span> <span class="n">_read_only_property</span><span class="p">(</span><span class="s1">&#39;lower_alarm_limit&#39;</span><span class="p">)</span>

    <span class="n">upper_warning_limit</span> <span class="o">=</span> <span class="n">_read_only_property</span><span class="p">(</span><span class="s1">&#39;upper_warning_limit&#39;</span><span class="p">)</span>
    <span class="n">lower_warning_limit</span> <span class="o">=</span> <span class="n">_read_only_property</span><span class="p">(</span><span class="s1">&#39;lower_warning_limit&#39;</span><span class="p">)</span>

    <span class="n">upper_ctrl_limit</span> <span class="o">=</span> <span class="n">_read_only_property</span><span class="p">(</span><span class="s1">&#39;upper_ctrl_limit&#39;</span><span class="p">)</span>
    <span class="n">lower_ctrl_limit</span> <span class="o">=</span> <span class="n">_read_only_property</span><span class="p">(</span><span class="s1">&#39;lower_ctrl_limit&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getnewargs_ex__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__getnewargs_ex__</span><span class="p">()</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">units</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
            <span class="n">upper_disp_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_disp_limit</span><span class="p">,</span>
            <span class="n">lower_disp_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_disp_limit</span><span class="p">,</span>
            <span class="n">upper_alarm_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_alarm_limit</span><span class="p">,</span>
            <span class="n">lower_alarm_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_alarm_limit</span><span class="p">,</span>
            <span class="n">upper_warning_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_warning_limit</span><span class="p">,</span>
            <span class="n">lower_warning_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_warning_limit</span><span class="p">,</span>
            <span class="n">upper_ctrl_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_ctrl_limit</span><span class="p">,</span>
            <span class="n">lower_ctrl_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_ctrl_limit</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">verify_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">val</span><span class="p">,</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># data is an array -- limits do not apply.</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_ctrl_limit</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_ctrl_limit</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_ctrl_limit</span> <span class="o">&lt;=</span> <span class="n">val</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_ctrl_limit</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CannotExceedLimits</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Cannot write data </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">. Limits are set to &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_ctrl_limit</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_ctrl_limit</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>

        <span class="k">def</span> <span class="nf">limit_checker</span><span class="p">(</span>
                <span class="n">value</span><span class="p">,</span>
                <span class="n">lo_attr</span><span class="p">,</span> <span class="n">hi_attr</span><span class="p">,</span>
                <span class="n">lo_status</span><span class="p">,</span> <span class="n">hi_status</span><span class="p">,</span>
                <span class="n">lo_severity_attr</span><span class="p">,</span>
                <span class="n">hi_severity_attr</span><span class="p">,</span>
                <span class="n">dflt_lo_severity</span><span class="p">,</span>
                <span class="n">dflt_hi_severity</span><span class="p">):</span>

            <span class="k">def</span> <span class="nf">limit_getter</span><span class="p">(</span><span class="n">limit_attr</span><span class="p">,</span> <span class="n">severity_attr</span><span class="p">,</span> <span class="n">dflt_severity</span><span class="p">):</span>
                <span class="n">sev</span> <span class="o">=</span> <span class="n">dflt_severity</span>
                <span class="n">limit</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit_attr</span><span class="p">)</span>

                <span class="n">sev_prop</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;field_inst&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="n">severity_attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sev_prop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># TODO sort out where ints are getting through...</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sev_prop</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="n">sev</span> <span class="o">=</span> <span class="n">sev_prop</span><span class="o">.</span><span class="n">enum_strings</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">sev_prop</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">limit</span><span class="p">,</span> <span class="n">AlarmSeverity</span><span class="p">(</span><span class="n">sev</span><span class="p">)</span>

            <span class="n">lo_limit</span><span class="p">,</span> <span class="n">lo_severity</span> <span class="o">=</span> <span class="n">limit_getter</span><span class="p">(</span>
                <span class="n">lo_attr</span><span class="p">,</span> <span class="n">lo_severity_attr</span><span class="p">,</span> <span class="n">dflt_lo_severity</span><span class="p">)</span>
            <span class="n">hi_limit</span><span class="p">,</span> <span class="n">hi_severity</span> <span class="o">=</span> <span class="n">limit_getter</span><span class="p">(</span>
                <span class="n">hi_attr</span><span class="p">,</span> <span class="n">hi_severity_attr</span><span class="p">,</span> <span class="n">dflt_hi_severity</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lo_limit</span> <span class="o">!=</span> <span class="n">hi_limit</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="n">lo_limit</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">lo_status</span><span class="p">,</span> <span class="n">lo_severity</span>

                <span class="k">elif</span> <span class="n">hi_limit</span> <span class="o">&lt;=</span> <span class="n">value</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">hi_status</span><span class="p">,</span> <span class="n">hi_severity</span>

            <span class="k">return</span> <span class="n">AlarmStatus</span><span class="o">.</span><span class="n">NO_ALARM</span><span class="p">,</span> <span class="n">AlarmSeverity</span><span class="o">.</span><span class="n">NO_ALARM</span>

        <span class="c1"># this is HIHI and LOLO limits</span>
        <span class="n">asts</span><span class="p">,</span> <span class="n">asver</span> <span class="o">=</span> <span class="n">limit_checker</span><span class="p">(</span><span class="n">val</span><span class="p">,</span>
                                    <span class="s1">&#39;lower_alarm_limit&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;upper_alarm_limit&#39;</span><span class="p">,</span>
                                    <span class="n">AlarmStatus</span><span class="o">.</span><span class="n">LOLO</span><span class="p">,</span>
                                    <span class="n">AlarmStatus</span><span class="o">.</span><span class="n">HIHI</span><span class="p">,</span>
                                    <span class="s1">&#39;lolo_severity&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;hihi_severity&#39;</span><span class="p">,</span>
                                    <span class="n">AlarmSeverity</span><span class="o">.</span><span class="n">MAJOR_ALARM</span><span class="p">,</span>
                                    <span class="n">AlarmSeverity</span><span class="o">.</span><span class="n">MAJOR_ALARM</span><span class="p">)</span>
        <span class="c1"># if HIHI and LOLO did not trigger as alarm, see if HIGH and LOW do</span>
        <span class="k">if</span> <span class="n">asts</span> <span class="ow">is</span> <span class="n">AlarmStatus</span><span class="o">.</span><span class="n">NO_ALARM</span><span class="p">:</span>
            <span class="c1"># this is HIGH and LOW limits</span>
            <span class="n">asts</span><span class="p">,</span> <span class="n">asver</span> <span class="o">=</span> <span class="n">limit_checker</span><span class="p">(</span><span class="n">val</span><span class="p">,</span>
                                        <span class="s1">&#39;lower_warning_limit&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;upper_warning_limit&#39;</span><span class="p">,</span>
                                        <span class="n">AlarmStatus</span><span class="o">.</span><span class="n">LOW</span><span class="p">,</span>
                                        <span class="n">AlarmStatus</span><span class="o">.</span><span class="n">HIGH</span><span class="p">,</span>
                                        <span class="s1">&#39;low_severity&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;high_severity&#39;</span><span class="p">,</span>
                                        <span class="n">AlarmSeverity</span><span class="o">.</span><span class="n">MINOR_ALARM</span><span class="p">,</span>
                                        <span class="n">AlarmSeverity</span><span class="o">.</span><span class="n">MINOR_ALARM</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">asts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">severity</span> <span class="o">=</span> <span class="n">asver</span>

        <span class="k">return</span> <span class="n">data</span>


<div class="viewcode-block" id="ChannelShort"><a class="viewcode-back" href="../../generated/caproto.ChannelShort.html#caproto.ChannelShort">[docs]</a><span class="k">class</span> <span class="nc">ChannelShort</span><span class="p">(</span><span class="n">ChannelNumeric</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    16-bit SHORT integer data and metadata which can be sent over a channel.</span>

<span class="sd">    May be a single value or an array of values.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    value : int or list of int</span>
<span class="sd">        Default starting value.</span>
<span class="sd">    timestamp : float, optional</span>
<span class="sd">        Posix timestamp associated with the value. Defaults to ``time.time()``.</span>
<span class="sd">    max_length : int, optional</span>
<span class="sd">        Maximum array length of the data.</span>
<span class="sd">    string_encoding : str, optional</span>
<span class="sd">        Encoding to use for strings, used when serializing and deserializing</span>
<span class="sd">        data.</span>
<span class="sd">    reported_record_type : str, optional</span>
<span class="sd">        Though this is not a record, the channel access protocol supports</span>
<span class="sd">        querying the record type.  This can be set to mimic an actual</span>
<span class="sd">        record or be set to something arbitrary.  Defaults to &#39;caproto&#39;.</span>
<span class="sd">    units : str, optional</span>
<span class="sd">        Engineering units indicator, which can be retrieved over channel</span>
<span class="sd">        access.</span>
<span class="sd">    upper_disp_limit : int, optional</span>
<span class="sd">        Upper display limit.</span>
<span class="sd">    lower_disp_limit : int, optional</span>
<span class="sd">        Lower display limit.</span>
<span class="sd">    upper_alarm_limit : int, optional</span>
<span class="sd">        Upper alarm limit.</span>
<span class="sd">    upper_warning_limit : int, optional</span>
<span class="sd">        Upper warning limit.</span>
<span class="sd">    lower_warning_limit : int, optional</span>
<span class="sd">        Lower warning limit.</span>
<span class="sd">    lower_alarm_limit : int, optional</span>
<span class="sd">        Lower alarm limit.</span>
<span class="sd">    upper_ctrl_limit : int, optional</span>
<span class="sd">        Upper control limit.</span>
<span class="sd">    lower_ctrl_limit : int, optional</span>
<span class="sd">        Lower control limit.</span>
<span class="sd">    value_atol : int, optional</span>
<span class="sd">        Archive tolerance value.</span>
<span class="sd">    log_atol : int, optional</span>
<span class="sd">        Log tolerance value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data_type</span> <span class="o">=</span> <span class="n">ChannelType</span><span class="o">.</span><span class="n">INT</span></div>


<div class="viewcode-block" id="ChannelInteger"><a class="viewcode-back" href="../../generated/caproto.ChannelInteger.html#caproto.ChannelInteger">[docs]</a><span class="k">class</span> <span class="nc">ChannelInteger</span><span class="p">(</span><span class="n">ChannelNumeric</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    32-bit LONG integer data and metadata which can be sent over a channel.</span>

<span class="sd">    May be a single value or an array of values.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    value : int or list of int</span>
<span class="sd">        Default starting value.</span>
<span class="sd">    timestamp : float, optional</span>
<span class="sd">        Posix timestamp associated with the value. Defaults to ``time.time()``.</span>
<span class="sd">    max_length : int, optional</span>
<span class="sd">        Maximum array length of the data.</span>
<span class="sd">    string_encoding : str, optional</span>
<span class="sd">        Encoding to use for strings, used when serializing and deserializing</span>
<span class="sd">        data.</span>
<span class="sd">    reported_record_type : str, optional</span>
<span class="sd">        Though this is not a record, the channel access protocol supports</span>
<span class="sd">        querying the record type.  This can be set to mimic an actual</span>
<span class="sd">        record or be set to something arbitrary.  Defaults to &#39;caproto&#39;.</span>
<span class="sd">    units : str, optional</span>
<span class="sd">        Engineering units indicator, which can be retrieved over channel</span>
<span class="sd">        access.</span>
<span class="sd">    upper_disp_limit : int, optional</span>
<span class="sd">        Upper display limit.</span>
<span class="sd">    lower_disp_limit : int, optional</span>
<span class="sd">        Lower display limit.</span>
<span class="sd">    upper_alarm_limit : int, optional</span>
<span class="sd">        Upper alarm limit.</span>
<span class="sd">    upper_warning_limit : int, optional</span>
<span class="sd">        Upper warning limit.</span>
<span class="sd">    lower_warning_limit : int, optional</span>
<span class="sd">        Lower warning limit.</span>
<span class="sd">    lower_alarm_limit : int, optional</span>
<span class="sd">        Lower alarm limit.</span>
<span class="sd">    upper_ctrl_limit : int, optional</span>
<span class="sd">        Upper control limit.</span>
<span class="sd">    lower_ctrl_limit : int, optional</span>
<span class="sd">        Lower control limit.</span>
<span class="sd">    value_atol : int, optional</span>
<span class="sd">        Archive tolerance value.</span>
<span class="sd">    log_atol : int, optional</span>
<span class="sd">        Log tolerance value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data_type</span> <span class="o">=</span> <span class="n">ChannelType</span><span class="o">.</span><span class="n">LONG</span></div>


<div class="viewcode-block" id="ChannelFloat"><a class="viewcode-back" href="../../generated/caproto.ChannelFloat.html#caproto.ChannelFloat">[docs]</a><span class="k">class</span> <span class="nc">ChannelFloat</span><span class="p">(</span><span class="n">ChannelNumeric</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    32-bit floating point data and metadata which can be sent over a channel.</span>

<span class="sd">    May be a single value or an array of values.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    value : float or list of float</span>
<span class="sd">        Initial value for the data.</span>
<span class="sd">    timestamp : float, optional</span>
<span class="sd">        Posix timestamp associated with the value. Defaults to ``time.time()``.</span>
<span class="sd">    max_length : int, optional</span>
<span class="sd">        Maximum array length of the data.</span>
<span class="sd">    string_encoding : str, optional</span>
<span class="sd">        Encoding to use for strings, used when serializing and deserializing</span>
<span class="sd">        data.</span>
<span class="sd">    reported_record_type : str, optional</span>
<span class="sd">        Though this is not a record, the channel access protocol supports</span>
<span class="sd">        querying the record type.  This can be set to mimic an actual record or</span>
<span class="sd">        be set to something arbitrary.  Defaults to &#39;caproto&#39;.</span>
<span class="sd">    units : str, optional</span>
<span class="sd">        Engineering units indicator, which can be retrieved over channel</span>
<span class="sd">        access.</span>
<span class="sd">    upper_disp_limit : float, optional</span>
<span class="sd">        Upper display limit.</span>
<span class="sd">    lower_disp_limit : float, optional</span>
<span class="sd">        Lower display limit.</span>
<span class="sd">    upper_alarm_limit : float, optional</span>
<span class="sd">        Upper alarm limit.</span>
<span class="sd">    upper_warning_limit : float, optional</span>
<span class="sd">        Upper warning limit.</span>
<span class="sd">    lower_warning_limit : float, optional</span>
<span class="sd">        Lower warning limit.</span>
<span class="sd">    lower_alarm_limit : float, optional</span>
<span class="sd">        Lower alarm limit.</span>
<span class="sd">    upper_ctrl_limit : float, optional</span>
<span class="sd">        Upper control limit.</span>
<span class="sd">    lower_ctrl_limit : float, optional</span>
<span class="sd">        Lower control limit.</span>
<span class="sd">    value_atol : float, optional</span>
<span class="sd">        Archive tolerance value.</span>
<span class="sd">    log_atol : float, optional</span>
<span class="sd">        Log tolerance value.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">data_type</span> <span class="o">=</span> <span class="n">ChannelType</span><span class="o">.</span><span class="n">FLOAT</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">precision</span>

    <span class="n">precision</span> <span class="o">=</span> <span class="n">_read_only_property</span><span class="p">(</span><span class="s1">&#39;precision&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getnewargs_ex__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__getnewargs_ex__</span><span class="p">()</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">precision</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="ChannelDouble"><a class="viewcode-back" href="../../generated/caproto.ChannelDouble.html#caproto.ChannelDouble">[docs]</a><span class="k">class</span> <span class="nc">ChannelDouble</span><span class="p">(</span><span class="n">ChannelNumeric</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    64-bit floating point data and metadata which can be sent over a channel.</span>

<span class="sd">    May be a single value or an array of values.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    value : float or list of float</span>
<span class="sd">        Initial value for the data.</span>
<span class="sd">    timestamp : float, optional</span>
<span class="sd">        Posix timestamp associated with the value. Defaults to ``time.time()``.</span>
<span class="sd">    max_length : int, optional</span>
<span class="sd">        Maximum array length of the data.</span>
<span class="sd">    string_encoding : str, optional</span>
<span class="sd">        Encoding to use for strings, used when serializing and deserializing</span>
<span class="sd">        data.</span>
<span class="sd">    reported_record_type : str, optional</span>
<span class="sd">        Though this is not a record, the channel access protocol supports</span>
<span class="sd">        querying the record type.  This can be set to mimic an actual</span>
<span class="sd">        record or be set to something arbitrary.  Defaults to &#39;caproto&#39;.</span>
<span class="sd">    units : str, optional</span>
<span class="sd">        Engineering units indicator, which can be retrieved over channel</span>
<span class="sd">        access.</span>
<span class="sd">    upper_disp_limit : float, optional</span>
<span class="sd">        Upper display limit.</span>
<span class="sd">    lower_disp_limit : float, optional</span>
<span class="sd">        Lower display limit.</span>
<span class="sd">    upper_alarm_limit : float, optional</span>
<span class="sd">        Upper alarm limit.</span>
<span class="sd">    upper_warning_limit : float, optional</span>
<span class="sd">        Upper warning limit.</span>
<span class="sd">    lower_warning_limit : float, optional</span>
<span class="sd">        Lower warning limit.</span>
<span class="sd">    lower_alarm_limit : float, optional</span>
<span class="sd">        Lower alarm limit.</span>
<span class="sd">    upper_ctrl_limit : float, optional</span>
<span class="sd">        Upper control limit.</span>
<span class="sd">    lower_ctrl_limit : float, optional</span>
<span class="sd">        Lower control limit.</span>
<span class="sd">    value_atol : float, optional</span>
<span class="sd">        Archive tolerance value.</span>
<span class="sd">    log_atol : float, optional</span>
<span class="sd">        Log tolerance value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data_type</span> <span class="o">=</span> <span class="n">ChannelType</span><span class="o">.</span><span class="n">DOUBLE</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">precision</span>

    <span class="n">precision</span> <span class="o">=</span> <span class="n">_read_only_property</span><span class="p">(</span><span class="s1">&#39;precision&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getnewargs_ex__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__getnewargs_ex__</span><span class="p">()</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">precision</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="ChannelByte"><a class="viewcode-back" href="../../generated/caproto.ChannelByte.html#caproto.ChannelByte">[docs]</a><span class="k">class</span> <span class="nc">ChannelByte</span><span class="p">(</span><span class="n">ChannelNumeric</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    8-bit unencoded CHAR data plus metadata which can be sent over a channel.</span>

<span class="sd">    May be a single CHAR or an array of CHAR.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    value : int or bytes</span>
<span class="sd">        Initial starting data.</span>
<span class="sd">    timestamp : float, optional</span>
<span class="sd">        Posix timestamp associated with the value. Defaults to ``time.time()``.</span>
<span class="sd">    max_length : int, optional</span>
<span class="sd">        Maximum array length of the data.</span>
<span class="sd">    string_encoding : str, optional</span>
<span class="sd">        Encoding to use for strings, used when serializing and deserializing</span>
<span class="sd">        data.</span>
<span class="sd">    reported_record_type : str, optional</span>
<span class="sd">        Though this is not a record, the channel access protocol supports</span>
<span class="sd">        querying the record type.  This can be set to mimic an actual</span>
<span class="sd">        record or be set to something arbitrary.  Defaults to &#39;caproto&#39;.</span>
<span class="sd">    units : str, optional</span>
<span class="sd">        Engineering units indicator, which can be retrieved over channel</span>
<span class="sd">        access.</span>
<span class="sd">    upper_disp_limit : int, optional</span>
<span class="sd">        Upper display limit.</span>
<span class="sd">    lower_disp_limit : int, optional</span>
<span class="sd">        Lower display limit.</span>
<span class="sd">    upper_alarm_limit : int, optional</span>
<span class="sd">        Upper alarm limit.</span>
<span class="sd">    upper_warning_limit : int, optional</span>
<span class="sd">        Upper warning limit.</span>
<span class="sd">    lower_warning_limit : int, optional</span>
<span class="sd">        Lower warning limit.</span>
<span class="sd">    lower_alarm_limit : int, optional</span>
<span class="sd">        Lower alarm limit.</span>
<span class="sd">    upper_ctrl_limit : int, optional</span>
<span class="sd">        Upper control limit.</span>
<span class="sd">    lower_ctrl_limit : int, optional</span>
<span class="sd">        Lower control limit.</span>
<span class="sd">    value_atol : int, optional</span>
<span class="sd">        Archive tolerance value.</span>
<span class="sd">    log_atol : int, optional</span>
<span class="sd">        Log tolerance value.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># &#39;Limits&#39; on chars do not make much sense and are rarely used.</span>
    <span class="n">data_type</span> <span class="o">=</span> <span class="n">ChannelType</span><span class="o">.</span><span class="n">CHAR</span>
    <span class="n">_compatible_array_types</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;|u1&#39;</span><span class="p">,</span> <span class="s1">&#39;|i1&#39;</span><span class="p">,</span> <span class="s1">&#39;|b1&#39;</span><span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">string_encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">strip_null_terminator</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">string_encoding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CaprotoValueError</span><span class="p">(</span><span class="s1">&#39;ChannelByte cannot have a string encoding&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">strip_null_terminator</span> <span class="o">=</span> <span class="n">strip_null_terminator</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">string_encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">preprocess_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">preprocess_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_compatible_array</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_array_read_only</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="o">+</span> <span class="n">backend</span><span class="o">.</span><span class="n">array_types</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="k">return</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="p">([</span><span class="n">v</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">)))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="c1"># Allow a scalar byte value to be passed in</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">value</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CaprotoValueError</span><span class="p">(</span><span class="s1">&#39;ChannelByte does not accept decoded strings&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">strip_null_terminator</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">value</span></div>


<div class="viewcode-block" id="ChannelChar"><a class="viewcode-back" href="../../generated/caproto.ChannelChar.html#caproto.ChannelChar">[docs]</a><span class="k">class</span> <span class="nc">ChannelChar</span><span class="p">(</span><span class="n">ChannelData</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    8-bit encoded CHAR data plus metadata which can be sent over a channel.</span>

<span class="sd">    Allows for simple access over CA to the first 40 characters as a DBR_STRING</span>
<span class="sd">    when ``report_as_string`` is set.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    value : str</span>
<span class="sd">        Initial starting data.</span>
<span class="sd">    string_encoding : str, optional</span>
<span class="sd">        The string encoding to use, defaults to &#39;latin-1&#39;.</span>
<span class="sd">    timestamp : float, optional</span>
<span class="sd">        Posix timestamp associated with the value. Defaults to ``time.time()``.</span>
<span class="sd">    max_length : int, optional</span>
<span class="sd">        Maximum array length of the data.</span>
<span class="sd">    string_encoding : str, optional</span>
<span class="sd">        Encoding to use for strings, used when serializing and deserializing</span>
<span class="sd">        data.</span>
<span class="sd">    reported_record_type : str, optional</span>
<span class="sd">        Though this is not a record, the channel access protocol supports</span>
<span class="sd">        querying the record type.  This can be set to mimic an actual</span>
<span class="sd">        record or be set to something arbitrary.  Defaults to &#39;caproto&#39;.</span>
<span class="sd">    units : str, optional</span>
<span class="sd">        Engineering units indicator, which can be retrieved over channel</span>
<span class="sd">        access.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data_type</span> <span class="o">=</span> <span class="n">ChannelType</span><span class="o">.</span><span class="n">CHAR</span>
    <span class="n">_compatible_array_types</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;|u1&#39;</span><span class="p">,</span> <span class="s1">&#39;|i1&#39;</span><span class="p">,</span> <span class="s1">&#39;|b1&#39;</span><span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">alarm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">max_length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">string_encoding</span><span class="o">=</span><span class="s1">&#39;latin-1&#39;</span><span class="p">,</span>
                 <span class="n">reported_record_type</span><span class="o">=</span><span class="s1">&#39;caproto&#39;</span><span class="p">,</span> <span class="n">report_as_string</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">alarm</span><span class="o">=</span><span class="n">alarm</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span>
                         <span class="n">max_length</span><span class="o">=</span><span class="n">max_length</span><span class="p">,</span>
                         <span class="n">string_encoding</span><span class="o">=</span><span class="n">string_encoding</span><span class="p">,</span>
                         <span class="n">reported_record_type</span><span class="o">=</span><span class="n">reported_record_type</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">report_as_string</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_type</span> <span class="o">=</span> <span class="n">ChannelType</span><span class="o">.</span><span class="n">STRING</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">long_string_max_length</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;The maximum number of elements (length) of the current value&#39;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">max_length</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">max_length</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;The number of elements (length) of the current value&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_type</span> <span class="o">==</span> <span class="n">ChannelType</span><span class="o">.</span><span class="n">STRING</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">max_length</span>

    <span class="k">def</span> <span class="nf">preprocess_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">preprocess_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_compatible_array</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="o">+</span> <span class="n">backend</span><span class="o">.</span><span class="n">array_types</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="p">([</span><span class="n">v</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">)))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="c1"># Allow a scalar byte value to be passed in</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="n">value</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">string_encoding</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">string_encoding</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CaprotoValueError</span><span class="p">(</span><span class="s1">&#39;Invalid string&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">value</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SubscriptionType</span><span class="o">.</span><span class="n">DBE_LOG</span> <span class="o">|</span> <span class="n">SubscriptionType</span><span class="o">.</span><span class="n">DBE_VALUE</span><span class="p">)</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">flags</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">write_from_dbr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SubscriptionType</span><span class="o">.</span><span class="n">DBE_LOG</span> <span class="o">|</span> <span class="n">SubscriptionType</span><span class="o">.</span><span class="n">DBE_VALUE</span><span class="p">)</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">write_from_dbr</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">flags</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="ChannelString"><a class="viewcode-back" href="../../generated/caproto.ChannelString.html#caproto.ChannelString">[docs]</a><span class="k">class</span> <span class="nc">ChannelString</span><span class="p">(</span><span class="n">ChannelData</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    8-bit encoded string data plus metadata which can be sent over a channel.</span>

<span class="sd">    Allows for simple access over CA to the first 40 characters as a DBR_STRING</span>
<span class="sd">    when ``report_as_string`` is set.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    value : str</span>
<span class="sd">        Initial starting data.</span>
<span class="sd">    string_encoding : str, optional</span>
<span class="sd">        The string encoding to use, defaults to &#39;latin-1&#39;.</span>
<span class="sd">    long_string_max_length : str, optional</span>
<span class="sd">        When requested as a long string (DBR_CHAR over Channel Access), this</span>
<span class="sd">        is the reported maximum length.</span>
<span class="sd">    timestamp : float, optional</span>
<span class="sd">        Posix timestamp associated with the value. Defaults to ``time.time()``.</span>
<span class="sd">    max_length : int, optional</span>
<span class="sd">        Maximum array length of the data.</span>
<span class="sd">    string_encoding : str, optional</span>
<span class="sd">        Encoding to use for strings, used when serializing and deserializing</span>
<span class="sd">        data.</span>
<span class="sd">    reported_record_type : str, optional</span>
<span class="sd">        Though this is not a record, the channel access protocol supports</span>
<span class="sd">        querying the record type.  This can be set to mimic an actual</span>
<span class="sd">        record or be set to something arbitrary.  Defaults to &#39;caproto&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data_type</span> <span class="o">=</span> <span class="n">ChannelType</span><span class="o">.</span><span class="n">STRING</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">alarm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">max_length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">string_encoding</span><span class="o">=</span><span class="s1">&#39;latin-1&#39;</span><span class="p">,</span>
                 <span class="n">reported_record_type</span><span class="o">=</span><span class="s1">&#39;caproto&#39;</span><span class="p">,</span> <span class="n">long_string_max_length</span><span class="o">=</span><span class="mi">81</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">alarm</span><span class="o">=</span><span class="n">alarm</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span>
                         <span class="n">max_length</span><span class="o">=</span><span class="n">max_length</span><span class="p">,</span>
                         <span class="n">string_encoding</span><span class="o">=</span><span class="n">string_encoding</span><span class="p">,</span>
                         <span class="n">reported_record_type</span><span class="o">=</span><span class="n">reported_record_type</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_long_string_max_length</span> <span class="o">=</span> <span class="n">long_string_max_length</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">long_string_max_length</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;The maximum number of elements (length) of the current value&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_long_string_max_length</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">):</span>
        <span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SubscriptionType</span><span class="o">.</span><span class="n">DBE_LOG</span> <span class="o">|</span> <span class="n">SubscriptionType</span><span class="o">.</span><span class="n">DBE_VALUE</span><span class="p">)</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">flags</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">write_from_dbr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SubscriptionType</span><span class="o">.</span><span class="n">DBE_LOG</span> <span class="o">|</span> <span class="n">SubscriptionType</span><span class="o">.</span><span class="n">DBE_VALUE</span><span class="p">)</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">write_from_dbr</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">flags</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Daniel Allan.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>